<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Task Tool</title>

<meta name="theme-color" content="#3b2f2f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #3b2f2f;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
}

#taskInput {
  width: 92%;
  max-width: 480px;
  padding: 18px;
  font-size: 22px;
  line-height: 1.5;
  border: none;
  border-radius: 14px;
  margin-top: 14px;
  outline: none;
  background: #bbf7d0;
  color: #3b2f2f;
  font-family: inherit;
  overflow: hidden;
  resize: none;
  white-space: pre-wrap;
  overflow-wrap: break-word;
  min-height: 32px;
}

#taskInput:focus {
  outline: 2px solid #22c55e;
  outline-offset: 2px;
}

#charCount {
  width: 92%;
  max-width: 480px;
  text-align: right;
  font-size: 12px;
  color: #ddd;
  margin-top: 4px;
  margin-bottom: 6px;
}

.toolbar {
  width: 92%;
  max-width: 480px;
  display: flex;
  gap: 6px;
  margin: 10px 0 6px;
  align-items: center;
}

.toolbar button {
  padding: 6px 10px;
  font-size: 14px;
  font-weight: 600;
  border: none;
  border-radius: 10px;
  background: #4a3838;
  color: #fff;
  cursor: pointer;
}

.toolbar button.active {
  background: #2563eb;
}

#taskList {
  width: 92%;
  max-width: 480px;
  margin-top: 14px;
}

.task-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 2px 6px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  color: #fff;
  margin-bottom: 0;
  font-size: 14px;
}

.task-item.completed .task-text {
  text-decoration: line-through;
  opacity: 0.6;
}

.task-text {
  flex: 1;
  word-break: break-word;
  margin-right: 6px;
}

.task-text .tag {
  color: #a8f0c6;
  font-weight: 500;
}

.task-controls {
  display: flex;
  align-items: center;
  gap: 4px;
}

.task-controls input[type="checkbox"] {
  width: 14px;
  height: 14px;
}

.task-controls button {
  border: none;
  background: transparent;
  color: #fff;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  font-size: 14px;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 0;
}

.task-controls button svg {
  width: 16px;
  height: 16px;
  fill: #ccc;
  pointer-events: none;
}

.task-controls button.pinned svg {
  fill: #fce77d;
}
</style>
</head>
<body>

<textarea id="taskInput" placeholder="Task description (use #tags inline)…" maxlength="160"></textarea>
<div id="charCount">160</div>

<div class="toolbar">
  <button id="addTaskBtn">➕ Add</button>
  <button id="boldBtn">B</button>
  <button id="capsBtn">CAPS</button>
</div>

<div id="taskList"></div>

<div id="mirror" style="position:absolute; top:-9999px; left:-9999px; visibility:hidden; white-space: pre-wrap; word-wrap: break-word;"></div>

<script>
const taskInput = document.getElementById('taskInput');
const charCount = document.getElementById('charCount');
const addTaskBtn = document.getElementById('addTaskBtn');
const boldBtn = document.getElementById('boldBtn');
const capsBtn = document.getElementById('capsBtn');
const taskList = document.getElementById('taskList');
const mirror = document.getElementById('mirror');

let tasks = JSON.parse(localStorage.getItem('tasks') || '[]');

function saveTasks() {
  localStorage.setItem('tasks', JSON.stringify(tasks));
}

function escapeHTML(str) {
  return str.replace(/[&<>"']/g, m => ({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#39;'
  }[m]));
}

function parseTagsHTML(text) {
  return escapeHTML(text).replace(/(#\w+)/g, '<span class="tag">$1</span>');
}

function updateCharCount() {
  charCount.textContent = 160 - taskInput.value.length;
}

function autoGrow() {
  mirror.style.width = taskInput.offsetWidth + 'px';
  mirror.style.font = window.getComputedStyle(taskInput).font;
  mirror.style.lineHeight = window.getComputedStyle(taskInput).lineHeight;
  mirror.style.padding = window.getComputedStyle(taskInput).padding;
  mirror.style.border = window.getComputedStyle(taskInput).border;
  mirror.textContent = taskInput.value || taskInput.placeholder;
  taskInput.style.height = mirror.scrollHeight + 'px';
}

autoGrow();
taskInput.addEventListener('input', () => {
  updateCharCount();
  autoGrow();
});

boldBtn.onclick = () => {
  taskInput.style.fontWeight = taskInput.style.fontWeight === 'bold' ? 'normal' : 'bold';
  boldBtn.classList.toggle('active');
};

capsBtn.onclick = () => {
  taskInput.style.textTransform = taskInput.style.textTransform === 'uppercase' ? 'none' : 'uppercase';
  capsBtn.classList.toggle('active');
};

function createTask(text) {
  return {
    id: Date.now(),
    text: text.trim(),
    tags: (text.match(/#\w+/g) || []).map(t => t.trim()),
    completed: false,
    pinned: false,
    bold: taskInput.style.fontWeight === 'bold',
    caps: taskInput.style.textTransform === 'uppercase',
    createdAt: Date.now()
  };
}

function renderTasks() {
  taskList.innerHTML = '';
  const sortedTasks = [...tasks].sort((a,b) => b.pinned - a.pinned || b.createdAt - a.createdAt);

  sortedTasks.forEach(task => {
    const div = document.createElement('div');
    div.className = 'task-item';
    if(task.completed) div.classList.add('completed');

    const span = document.createElement('span');
    span.className = 'task-text';
    let taskText = task.text;
    if(task.caps) taskText = taskText.toUpperCase();
    span.innerHTML = parseTagsHTML(taskText);
    span.style.fontWeight = task.bold ? 'bold' : 'normal';

    const controls = document.createElement('div');
    controls.className = 'task-controls';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = task.completed;
    checkbox.onclick = () => {
      task.completed = !task.completed;
      saveTasks();
      renderTasks();
    };

    const pinBtn = document.createElement('button');
    pinBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 2L15 8L22 9L17 14L18 21L12 18L6 21L7 14L2 9L9 8Z"></path></svg>';
    pinBtn.classList.toggle('pinned', task.pinned);
    pinBtn.onclick = () => {
      task.pinned = !task.pinned;
      saveTasks();
      renderTasks();
    };

    const boldTaskBtn = document.createElement('button');
    boldTaskBtn.innerHTML = 'B';
    boldTaskBtn.style.fontWeight = task.bold ? 'bold' : 'normal';
    boldTaskBtn.onclick = () => {
      task.bold = !task.bold;
      saveTasks();
      renderTasks();
    };

    const delBtn = document.createElement('button');
    delBtn.textContent = '×';
    delBtn.onclick = () => {
      const confirmDelete = confirm("Are you sure you want to delete this task?");
      if (!confirmDelete) return;

      tasks = tasks.filter(t => t.id !== task.id);
      saveTasks();
      renderTasks();
    };

    controls.appendChild(checkbox);
    controls.appendChild(pinBtn);
    controls.appendChild(boldTaskBtn);
    controls.appendChild(delBtn);

    div.appendChild(span);
    div.appendChild(controls);
    taskList.appendChild(div);
  });
}

function resetTaskInput() {
  taskInput.value = '';
  updateCharCount();
  requestAnimationFrame(() => {
    taskInput.scrollTop = 0;
    taskInput.selectionStart = taskInput.selectionEnd = 0;
    autoGrow();
    taskInput.focus();
  });
}

function addTask() {
  const text = taskInput.value.trim();
  if(!text) return;
  tasks.unshift(createTask(text));
  saveTasks();
  renderTasks();
  resetTaskInput();
}

addTaskBtn.onclick = addTask;
taskInput.addEventListener('keydown', e => { if(e.key === 'Enter') addTask(); });

renderTasks();
updateCharCount();
</script>

</body>
</html>
